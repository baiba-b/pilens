@page "/ToDo"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@using Pilens.Data.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISnackbar SnackbarService
@inject AuthenticationStateProvider _authenticationStateProvider

<AuthorizeView>
    <Authorized>
        <MudPaper Class="mt-2 pa-3 d-inline-block">
            <MudContainer>
                <MudText>@ErrorMessage</MudText>

                <MudStack Direction="Row" Spacing="2" Class="mb-4">
                    <MudTextField @bind-value="NewGroupName"
                                  Label="Jaunas grupas nosaukums"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Disabled="@string.IsNullOrWhiteSpace(NewGroupName)"
                               OnClick="CreateGroupAsync">
                        Izveidot grupu
                    </MudButton>
                </MudStack>

                <MudDropContainer T="ToDoTask" Items="Items" ItemsSelector="@((item, dropzone) => item.Identifier == dropzone)" ItemDropped="ItemUpdated" Class="d-flex flex-wrap flex-grow-1">
                    <ChildContent>
                        <MudGrid Spacing="4">
                            <MudItem xs="12" md="6">
                                <MudDropZone T="ToDoTask"
                                             Items="Items"
                                             Identifier="Saraksts"
                                             Class="rounded-lg mud-alert-text-info pa-4 h-100">
                                    <MudText Typo="Typo.h6" Class="mb-4">Saraksts</MudText>
                                </MudDropZone>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudDropZone T="ToDoTask"
                                             Items="Items"
                                             Identifier="Sesijas"
                                             Class="rounded-lg mud-alert-text-success pa-4 h-100">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.h6">Sesijas darāmais</MudText>
                                        <MudText Typo="Typo.subtitle2">Kopā sesijas: @TotalSessions</MudText>
                                    </MudStack>
                                </MudDropZone>
                                <MudCardActions Class="mt-4">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Disabled="@(!CanStartPomodoro)"
                                               OnClick="StartPomodoroFromDropzoneAsync">
                                        Sākt Pomodoro
                                    </MudButton>
                                </MudCardActions>
                            </MudItem>
                        </MudGrid>
                    </ChildContent>

                    <ItemRenderer Context="itemContext">
                        <div class="d-flex flex-grow-1 gap-2 align-items-center">
                            <MudCheckBox Class="flex-initial" @bind-value="@itemContext.IsCompleted" Color="Color.Primary" @onclick="@(() => ToggleCompletion(itemContext))" />

                            <MudStack>
                                <MudTextField Class="flex-1" @bind-Value="@itemContext.Title" ReadOnly="true" Margin="Margin.Dense" Variant="Variant.Outlined" />


                                <MudStack Class="flex-1" Spacing="0">
                                    <MudProgressLinear Color="Color.Primary"
                                                       Value="@GetProgressPercent(itemContext)"
                                                       Class="my-1" />
                                    <MudText Typo="Typo.caption">
                                        @($"{itemContext.ProgressCurrentUnits}/{itemContext.ProgressTargetUnits} {itemContext.ProgressUnitType}")
                                    </MudText>
                                </MudStack>

                            </MudStack>

                            <MudCardActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => StartEdit(itemContext))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveTask(itemContext))" />
                            </MudCardActions>
                        </div>
                    </ItemRenderer>
                </MudDropContainer>
                <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                               Size="Size.Large"
                               Color="Color.Primary"
                               @onclick="NavigateToCreate" />
            </MudContainer>
        </MudPaper>
    </Authorized>
    </AuthorizeView>
