@page "/ToDo/update/{TaskId:int}"
@rendermode InteractiveServer
@using Pilens.Data.Models
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject ISnackbar SnackbarService
@attribute [Authorize]

<AuthorizeView>
    <Authorized>
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <MudAlert Severity="Severity.Error">@ErrorMessage</MudAlert>
        }
        else if (task is null)
        {
            <MudProgressCircular Class="m-4" />
        }
        else
        {
            <MudCardContent>
                <MudForm @bind-IsValid="_formIsValid" @ref="todoForm" autocomplete="off" OnValidSubmit="UpdateTask">
                    <MudTextField @bind-Value="task.Title"
                                  Label="Nosaukums"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  RequiredError="@ToDoTaskReqError"
                                  MaxLength="200"
                                  Validation="@(new Func<string, string>(TitleValidation))" />
                    <MudTextField @bind-Value="task.Description"
                                  Label="Apraksts"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="3"
                                  MaxLength="500"
                                  Validation="@(new Func<string, string>(DescriptionValidation))" />

                    <MudStack Direction="Row" Spacing="2">
                        <MudTextField @bind-Value="task.EffortDuration"
                                      Label="Nepieciešamais laiks izpildei (HH:MM)"
                                      Mask="@(new PatternMask("00:00"))"
                                      Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      Placeholder="00:30"
                                      Required="true"
                                      RequiredError="@ToDoTaskReqError"
                                      Validation="@(new Func<TimeSpan, string>(EffortDurationValidation))" />
                        <MudNumericField T="int"
                                         @bind-Value="task.Effort"
                                         Label="Grūtības līmenis (1–3)"
                                         Margin="Margin.Dense"
                                         Variant="Variant.Outlined"
                                         Placeholder="1"
                                         Required="true"
                                         RequiredError="@ToDoTaskReqError"
                                         Min="1"
                                         Max="3"
                                         Validation="@(new Func<int, string>(EffortValidation))" />
                    </MudStack>

                    <MudDatePicker Label="Uzdevuma termiņš"
                                   @bind-value="task.Deadline"
                                   Required="true"
                                   RequiredError="@ToDoTaskReqError"
                                   Validation="@(new Func<DateTime, string>(DeadlineValidation))" />

                    <MudSelect T="Group" Label="Grupas" MultiSelection="true" @bind-SelectedValues="selectedGroups">
                        @foreach (var group in groups)
                        {
                            <MudSelectItem Value="@group">@group.Name</MudSelectItem>
                        }
                    </MudSelect>

                    <MudStack Direction="Row" Spacing="2">
                        <MudNumericField T="int"
                                         @bind-Value="task.ProgressCurrentUnits"
                                         Label="@($"Izpildītie(-ās) {task.ProgressUnitType}")"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Min="0"
                                         Validation="@(new Func<int, string>(ProgressCurrentValidation))" />

                        <MudNumericField T="int"
                                         @bind-Value="task.ProgressTargetUnits"
                                         Label="@($"Mērķa {task.ProgressUnitType}")"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Min="0"
                                         Validation="@(new Func<int, string>(ProgressTargetValidation))" />
                    </MudStack>

                    <MudTextField @bind-Value="task.ProgressUnitType"
                                  Label="Vienības tips"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Validation="@(new Func<string, string>(ProgressUnitTypeValidation))" />

                    <MudStack Spacing="0" Class="mt-1" Style="max-width: 420px;">
                        <MudProgressLinear Color="Color.Primary"
                                           Value="@((task.ProgressTargetUnits > 0)
                                                ? Math.Clamp((double)task.ProgressCurrentUnits / task.ProgressTargetUnits * 100.0, 0, 100)
                                                : 0)"
                                           Class="my-1" />
                        <MudText Typo="Typo.caption">
                            @($"{task.ProgressCurrentUnits}/{task.ProgressTargetUnits} {task.ProgressUnitType}")
                        </MudText>
                    </MudStack>

                    <MudCardActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Save"
                                       Size="Size.Large"
                                       Color="Color.Primary"
                                       OnClick="UpdateTask" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Size="Size.Medium"
                                       Color="Color.Default"
                                       OnClick="Cancel" />
                    </MudCardActions>
                </MudForm>
            </MudCardContent>
        }
    </Authorized>
</AuthorizeView>
