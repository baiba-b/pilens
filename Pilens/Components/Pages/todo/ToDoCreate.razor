@page "/ToDo/create"
@rendermode InteractiveServer
@using Pilens.Data.DTO
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AuthenticationStateProvider _authenticationStateProvider
@inject ISnackbar SnackbarService

<AuthorizeView>
    <Authorized>
        <MudCardContent>
            <MudForm @bind-IsValid="_formIsValid" @ref="todoForm" autocomplete="off" OnValidSubmit="CreateTask">
                <MudTextField @bind-Value="todoTaskDto.Title"
                              Label="Nosaukums"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Required="true"
                              RequiredError="@ToDoTaskReqError"
                              MaxLength="200"
                              Validation="@(new Func<string, string>(TitleValidation))" />

                <MudTextField @bind-Value="todoTaskDto.Description"
                              Label="Apraksts"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Lines="3"
                              MaxLength="500"
                              Validation="@(new Func<string, string>(DescriptionValidation))" />

                <MudStack Direction="Row" Spacing="2">
                    <!-- Pieprasītais laiks – HH:MM -->
                    <MudTextField @bind-Value="todoTaskDto.EffortDuration"
                                  Label="Nepieciešamais laiks izpildei (HH:MM)"
                                  Mask="@(new PatternMask("00:00"))"
                                  Margin="Margin.Dense"
                                  Variant="Variant.Outlined"
                                  Placeholder="00:30"
                                  Required="true"
                                  RequiredError="@ToDoTaskReqError"
                                  Validation="@(new Func<TimeSpan, string>(EffortDurationValidation))" />

                    <!-- Grūtības līmenis (1–3) -->
                    <MudNumericField T="int"
                                     @bind-Value="todoTaskDto.Effort"
                                     Label="Grūtības līmenis (1–3)"
                                     Margin="Margin.Dense"
                                     Variant="Variant.Outlined"
                                     Placeholder="1"
                                     Required="true"
                                     RequiredError="@ToDoTaskReqError"
                                     Min="1"
                                     Max="3"
                                     Validation="@(new Func<int, string>(EffortValidation))" />
                </MudStack>

                <!-- Datums  -->
                <MudDatePicker Label="Uzdevuma termiņš"
                               @bind-Date="todoTaskDto.Deadline"
                               Required="true"
                               RequiredError="@ToDoTaskReqError"
                               Validation="@(new Func<DateTime?, string>(DeadlineValidation))" />

                <MudStack Direction="Row" Spacing="2">
                    <!-- Progresa esošās vienības: pozitīvs skaitlis -->
                    <MudNumericField T="int"
                                     @bind-Value="todoTaskDto.ProgressCurrentUnits"
                                     Label="@($"Izpildītie(-ās) {todoTaskDto.ProgressUnitType}")"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Min="0"
                                     Validation="@(new Func<int, string>(ProgressCurrentValidation))" />

                    <!-- Progresa mērķa vienības: pozitīvs skaitlis -->
                    <MudNumericField T="int"
                                     @bind-Value="todoTaskDto.ProgressTargetUnits"
                                     Label="@($"Mērķa {todoTaskDto.ProgressUnitType}")"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Min="0"
                                     Validation="@(new Func<int, string>(ProgressTargetValidation))" />
                </MudStack>

                <!-- Vienības tips  -->
                <MudTextField @bind-Value="todoTaskDto.ProgressUnitType"
                              Label="Vienības tips"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Validation="@(new Func<string, string>(ProgressUnitTypeValidation))" />

                <!-- Grupa: 0..n -->
                <MudSelect T="GroupDTO" Label="Grupas" MultiSelection="true" @bind-SelectedValues="selectedGroups">
                    @foreach (var group in groups)
                    {
                        <MudSelectItem Value="@group">@group.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudStack Spacing="0" Class="mt-1" Style="max-width: 420px;">
                    <MudProgressLinear Color="Color.Primary"
                                       Value="@((todoTaskDto.ProgressTargetUnits > 0)? Math.Clamp((double)todoTaskDto.ProgressCurrentUnits / todoTaskDto.ProgressTargetUnits * 100.0, 0, 100) : 0)"
                                       Class="my-1" />
                    <MudText Typo="Typo.caption">
                        @($"{todoTaskDto.ProgressCurrentUnits}/{todoTaskDto.ProgressTargetUnits} {todoTaskDto.ProgressUnitType}")
                    </MudText>
                </MudStack>

                <MudSelect T="GroupDTO" Label="Grupas" MultiSelection="true" @bind-SelectedValues="selectedGroups">
                    @foreach (var group in groups)
                    {
                        <MudSelectItem Value="@group">@group.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudCardActions>
                    <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                   Size="Size.Large"
                                   Color="Color.Primary"
                                   OnClick="CreateTask" />
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Medium"
                                   Color="Color.Default"
                                   OnClick="Cancel" />
                </MudCardActions>
            </MudForm>
        </MudCardContent>
    </Authorized>
</AuthorizeView>
